<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android JS Bridge Pro</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .card { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px; cursor: pointer; }
        .btn:active { background: #0056b3; }
        code { background: #eee; padding: 2px 5px; border-radius: 3px; }
        #video-container { width: 100%; max-width: 400px; height: 300px; background: #000; margin: 10px auto; display: none; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #photo-preview { max-width: 100%; margin-top: 10px; }
    </style>
</head>
<body>
<h2>ğŸ“± è·¨å¹³å° WebApp æµ‹è¯•</h2>

<!-- ç¯å¢ƒæ£€æµ‹ -->
<div class="card">
    <h3>ğŸŒ è¿è¡Œç¯å¢ƒ</h3>
    <div id="environment-info">æ£€æµ‹ä¸­...</div>
</div>

<!-- æ‘„åƒå¤´æµ‹è¯• -->
<div class="card">
    <h3>ğŸ“· æ‘„åƒå¤´å…¼å®¹æ€§æµ‹è¯•</h3>
    <p>æµ‹è¯•æµè§ˆå™¨å’Œ WebView ä¸­çš„æ‘„åƒå¤´å…¼å®¹æ€§</p>

    <!-- æ–¹æ¡ˆ1: æ ‡å‡†æ‘„åƒå¤´ -->
    <button class="btn" onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´ (æ ‡å‡†API)</button>
    <button class="btn" onclick="stopCamera()">åœæ­¢æ‘„åƒå¤´</button>

    <div id="video-container">
        <video id="camera-video" autoplay playsinline></video>
    </div>

    <button class="btn" onclick="takePhoto()">æ‹ç…§</button>
    <img id="photo-preview" alt="æ‹ç…§é¢„è§ˆ">

    <!-- æ–¹æ¡ˆ2: æ–‡ä»¶è¾“å…¥å¤‡ç”¨ -->
    <hr>
    <p>å¦‚æœä¸Šæ–¹æ‘„åƒå¤´å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆï¼š</p>
    <button class="btn" onclick="takePhotoWithInput()">æ‹ç…§/é€‰æ‹©å›¾ç‰‡ (å¤‡ç”¨æ–¹æ¡ˆ)</button>
</div>

<!-- è®¾å¤‡ä¿¡æ¯ -->
<div class="card">
    <h3>ğŸ“± è®¾å¤‡ä¿¡æ¯</h3>
    <div id="device-info">åŠ è½½ä¸­...</div>
</div>

<!-- äº¤äº’åŠŸèƒ½ -->
<div class="card">
    <h3>ğŸ”” äº¤äº’åé¦ˆ</h3>
    <button class="btn" onclick="showToast()">Toast æç¤º</button>
    <button class="btn" onclick="vibrateDevice()">éœ‡åŠ¨ 100ms</button>
</div>

<!-- å‰ªè´´æ¿ -->
<div class="card">
    <h3>ğŸ“‹ å‰ªè´´æ¿</h3>
    <input type="text" id="copy-input" value="Hello WebApp" style="padding:5px; width:200px;">
    <button class="btn" onclick="copyToClipboard()">å¤åˆ¶æ–‡æœ¬</button>
    <button class="btn" onclick="readFromClipboard()">è¯»å–å‰ªè´´æ¿</button>
    <div id="clip-result" style="margin-top:5px; color:green;"></div>
</div>

<!-- æ–‡ä»¶ç³»ç»Ÿ -->
<div class="card">
    <h3>ğŸ’¾ æ–‡ä»¶ç³»ç»Ÿ</h3>
    <button class="btn" onclick="readSampleFile()">è¯»å–ç¤ºä¾‹æ–‡ä»¶</button>
    <button class="btn" onclick="writeSampleFile()">å†™å…¥ç¤ºä¾‹æ–‡ä»¶</button>
    <div id="file-result" style="font-size:12px; max-height:100px; overflow:auto;"></div>
</div>

<!-- æƒé™ç®¡ç† -->
<div class="card">
    <h3>ğŸ” æƒé™ç®¡ç†</h3>
    <button class="btn" onclick="requestCameraPermission()">è¯·æ±‚æ‘„åƒå¤´æƒé™</button>
    <button class="btn" onclick="checkCameraPermission()">æ£€æŸ¥æ‘„åƒå¤´æƒé™</button>
    <div id="permission-result" style="margin-top:5px;"></div>
</div>

<script src="js/api.js"></script>
<script>
    // ç¯å¢ƒæ£€æµ‹
    function detectEnvironment() {
        const envInfo = document.getElementById('environment-info');
        if (window.isWebView()) {
            envInfo.innerHTML = `
                <span style="color: green;">âœ… è¿è¡Œåœ¨ WebView ä¸­</span><br>
                æ”¯æŒåŸç”Ÿ API: ${Object.keys(window.Android || {}).length} ä¸ª
            `;
        } else {
            envInfo.innerHTML = `
                <span style="color: blue;">ğŸŒ è¿è¡Œåœ¨æµè§ˆå™¨ä¸­</span><br>
                ç”¨æˆ·ä»£ç†: ${navigator.userAgent.substring(0, 50)}...
            `;
        }
    }

    // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
    async function showDeviceInfo() {
        const deviceInfo = await window.NativeAPI.getDeviceInfo();
        const infoDiv = document.getElementById('device-info');

        if (deviceInfo) {
            infoDiv.innerHTML = `
                è®¾å¤‡å‹å·: ${deviceInfo.model}<br>
                åˆ¶é€ å•†: ${deviceInfo.manufacturer}<br>
                ç³»ç»Ÿ: ${deviceInfo.androidVersion || 'Browser'}<br>
                å±å¹•: ${deviceInfo.screenWidth} Ã— ${deviceInfo.screenHeight}<br>
                è¯­è¨€: ${deviceInfo.locale}<br>
                æ—¶åŒº: ${deviceInfo.timezone}
            `;
        } else {
            infoDiv.innerHTML = 'æ— æ³•è·å–è®¾å¤‡ä¿¡æ¯';
        }
    }

    // æ‘„åƒå¤´ç›¸å…³å˜é‡
    let cameraStream = null;

    // å¯åŠ¨æ‘„åƒå¤´
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            // ä½¿ç”¨å…¼å®¹çš„æ‘„åƒå¤´ API
            cameraStream = await window.CameraAPI.getMediaStream(constraints);

            const video = document.getElementById('camera-video');
            video.srcObject = cameraStream;

            const container = document.getElementById('video-container');
            container.style.display = 'block';

            window.NativeAPI.toast('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
        } catch (error) {
            console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
            window.NativeAPI.toast(`æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ${error.message}`);
        }
    }

    // åœæ­¢æ‘„åƒå¤´
    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;

            const video = document.getElementById('camera-video');
            video.srcObject = null;

            document.getElementById('video-container').style.display = 'none';
            window.NativeAPI.toast('æ‘„åƒå¤´å·²åœæ­¢');
        }
    }

    // æ‹ç…§
    async function takePhoto() {
        try {
            // ä½¿ç”¨å…¼å®¹çš„æ‹ç…§ API
            const photoData = await window.CameraAPI.takePhoto({
                facingMode: 'environment',
                quality: 0.8,
                fallbackToFileInput: true
            });

            const preview = document.getElementById('photo-preview');
            preview.src = photoData;
            preview.style.display = 'block';

            window.NativeAPI.toast('æ‹ç…§æˆåŠŸ');
        } catch (error) {
            console.error('æ‹ç…§å¤±è´¥:', error);
            window.NativeAPI.toast(`æ‹ç…§å¤±è´¥: ${error.message}`);
        }
    }

    // ä½¿ç”¨æ–‡ä»¶è¾“å…¥æ‹ç…§
    async function takePhotoWithInput() {
        try {
            const photoData = await window.CameraAPI._takePhotoWithFileInput();

            const preview = document.getElementById('photo-preview');
            preview.src = photoData;
            preview.style.display = 'block';

            window.NativeAPI.toast('å›¾ç‰‡è·å–æˆåŠŸ');
        } catch (error) {
            console.error('æ–‡ä»¶è¾“å…¥å¤±è´¥:', error);
            window.NativeAPI.toast(`è·å–å›¾ç‰‡å¤±è´¥: ${error.message}`);
        }
    }

    // Toast æç¤º
    function showToast() {
        window.NativeAPI.toast('è¿™æ˜¯è·¨å¹³å°çš„ Toast æ¶ˆæ¯ï¼');
    }

    // éœ‡åŠ¨
    function vibrateDevice() {
        window.NativeAPI.vibrate(100);
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async function copyToClipboard() {
        const text = document.getElementById('copy-input').value;
        const success = await window.NativeAPI.copyToClipboard(text);
        window.NativeAPI.toast(success ? 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' : 'å¤åˆ¶å¤±è´¥');
    }

    // ä»å‰ªè´´æ¿è¯»å–
    async function readFromClipboard() {
        try {
            const text = await window.NativeAPI.getClipboard();
            document.getElementById('clip-result').innerText = `å‰ªè´´æ¿å†…å®¹: ${text}`;
            window.NativeAPI.toast('è¯»å–æˆåŠŸ');
        } catch (error) {
            document.getElementById('clip-result').innerText = 'è¯»å–å¤±è´¥: ' + error.message;
        }
    }

    // è¯»å–æ–‡ä»¶
    async function readSampleFile() {
        try {
            // å°è¯•è¯»å–å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶
            const content = await window.FileSystemAPI.readFile('./js/api.js');
            const resultDiv = document.getElementById('file-result');
            resultDiv.innerHTML = `<pre>${content.substring(0, 500)}...</pre>`;
            window.NativeAPI.toast('æ–‡ä»¶è¯»å–æˆåŠŸ');
        } catch (error) {
            console.error('è¯»å–æ–‡ä»¶å¤±è´¥:', error);
            window.NativeAPI.toast('æ–‡ä»¶è¯»å–å¤±è´¥');
        }
    }

    // å†™å…¥æ–‡ä»¶
    async function writeSampleFile() {
        try {
            const content = `è¿™æ˜¯æµ‹è¯•æ–‡ä»¶å†…å®¹ï¼Œåˆ›å»ºäº ${new Date().toLocaleString()}`;
            const success = await window.FileSystemAPI.writeFile('test.txt', content);
            window.NativeAPI.toast(success ? 'æ–‡ä»¶å·²ä¿å­˜' : 'æ–‡ä»¶ä¿å­˜å¤±è´¥');
        } catch (error) {
            console.error('å†™å…¥æ–‡ä»¶å¤±è´¥:', error);
            window.NativeAPI.toast('æ–‡ä»¶å†™å…¥å¤±è´¥');
        }
    }

    // è¯·æ±‚æ‘„åƒå¤´æƒé™
    async function requestCameraPermission() {
        const hasPermission = await window.NativeAPI.requestPermission('android.permission.CAMERA');
        const resultDiv = document.getElementById('permission-result');
        resultDiv.innerHTML = hasPermission ?
            '<span style="color: green;">âœ… æ‘„åƒå¤´æƒé™å·²æˆäºˆ</span>' :
            '<span style="color: red;">âŒ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»</span>';
    }

    // æ£€æŸ¥æ‘„åƒå¤´æƒé™
    async function checkCameraPermission() {
        const hasPermission = await window.NativeAPI.hasPermission('android.permission.CAMERA');
        const resultDiv = document.getElementById('permission-result');
        resultDiv.innerHTML = hasPermission ?
            '<span style="color: green;">âœ… å·²æœ‰æ‘„åƒå¤´æƒé™</span>' :
            '<span style="color: orange;">âš ï¸ æ— æ‘„åƒå¤´æƒé™</span>';
    }

    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
        detectEnvironment();
        await showDeviceInfo();

        // è‡ªåŠ¨æ£€æŸ¥æ‘„åƒå¤´æƒé™
        if (window.isWebView()) {
            await checkCameraPermission();
        }
    });
</script>
</body>
</html>