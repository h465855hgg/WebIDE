name: Android CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - 'renovate.json'
      - '.editorconfig'
      - '.gitignore'
      - '.github/**'
      - '.github/workflows/**'
      - '.idea/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - 'renovate.json'
      - '.editorconfig'
      - '.gitignore'
      - '.github/**'
      - '.github/workflows/**'
      - '.idea/**'
  workflow_dispatch:

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    if: ${{ !startsWith(github.event.head_commit.message, '[skip ci]') && (github.ref == 'refs/heads/main' || github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Decode and verify keystore (push -> main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          mkdir -p app
          # 清空可能存在的文件
          rm -f app/WebIDE.jks
          
          # 解码 base64
          echo "$KEYSTORE_B64" | base64 -d > app/WebIDE.jks
          
          # 验证文件大小
          echo "Keystore file size:"
          ls -lh app/WebIDE.jks
          
          # 验证文件类型
          echo "File type:"
          file app/WebIDE.jks
          
          # 尝试列出 keystore 内容（不验证密码）
          echo "Checking keystore structure:"
          keytool -list -keystore app/WebIDE.jks -storepass "$KEYSTORE_PASSWORD" || echo "密码验证失败，继续尝试构建"
        env:
          KEYSTORE_B64: ${{ secrets.KEYSTORE_B64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        
      - name: Build unsigned Release for PR
        if: github.event_name == 'pull_request'
        run: ./gradlew assembleRelease --warning-mode all --stacktrace

      - name: Build signed Release for main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # 调试：显示环境变量长度
          echo "Keystore password length: ${#KEYSTORE_PASSWORD}"
          echo "Key password length: ${#KEY_PASSWORD}"
          
          ./gradlew assembleRelease \
            -PKEYSTORE_FILE=WebIDE.jks \
            -PKEYSTORE_PASSWORD="$KEYSTORE_PASSWORD" \
            -PKEY_ALIAS=key0 \
            -PKEY_PASSWORD="$KEY_PASSWORD" \
            --warning-mode all --stacktrace
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
